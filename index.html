<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudyEase</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: #0F172A;
  color: #E5E7EB;
}

header {
  background: #1E293B;
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h1 {
  margin: 0;
  color: #3B82F6;
}

.account {
  display: flex;
  align-items: center;
  gap: 10px;
}

main {
  padding: 20px;
  display: grid;
  gap: 20px;
  max-width: 900px;
  margin: auto;
}

.card {
  background: #1E293B;
  padding: 20px;
  border-radius: 12px;
}

.grid {
  display: grid;
  gap: 20px;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
}

button {
  background: #3B82F6;
  border: none;
  padding: 8px 14px;
  color: white;
  border-radius: 8px;
  cursor: pointer;
}

button.done {
  background: #22C55E;
}

.goal {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
}

.highlight {
  font-size: 2rem;
  color: #22C55E;
  font-weight: bold;
}

footer {
  text-align: center;
  padding: 15px;
  color: #94A3B8;
}
</style>
</head>

<body>

<header>
  <h1>StudyEase</h1>
  <div class="account">
    <span id="welcomeMsg"></span>
    <button id="signInBtn" onclick="location.href='auth.html'">Sign In</button>
    <button id="signUpBtn" onclick="location.href='auth.html'">Sign Up</button>
    <button id="logoutBtn" onclick="logout()" style="display:none;">Log Out</button>
  </div>
</header>

<main>

<section class="card">
  <h2>‚ö° Quick Actions</h2>
  <button onclick="location.href='timer.html'">‚è± Study Timer</button>
  <button onclick="location.href='add_goal.html'">‚ûï Add Goal</button>
  <button onclick="location.href='goals.html'">üéØ View Goals</button>
</section>

<section class="grid">

  <div class="card">
    <h3>‚≠ê XP</h3>
    <p class="highlight"><span id="xp">0</span> XP</p>
  </div>

  <div class="card">
    <h3>üéØ Today‚Äôs Goals</h3>
    <div id="goalsList">Loading...</div>
  </div>

</section>

</main>

<footer>
  Made for students ‚Ä¢ No pressure üå±
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBMEmLkJ8_-A1iSD_IF2NccOJHdcRm_Lug",
  authDomain: "study-2f23d.firebaseapp.com",
  projectId: "study-2f23d",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const todayKey = new Date().toISOString().split("T")[0];

auth.onAuthStateChanged(async user => {
  if (!user) return;

  document.getElementById("welcomeMsg").innerText = `Hi, ${user.email}`;
  document.getElementById("logoutBtn").style.display = "inline-block";

  await loadXP(user);
  await processMissedGoals(user);
  await loadTodayGoals(user);
});

async function loadXP(user) {
  const ref = db.collection("users").doc(user.email);
  const snap = await ref.get();
  if (!snap.exists) await ref.set({ xp: 0 });

  document.getElementById("xp").innerText = snap.data().xp || 0;
}

async function loadTodayGoals(user) {
  const goalsBox = document.getElementById("goalsList");
  goalsBox.innerHTML = "";

  const snap = await db.collection("users")
    .doc(user.email)
    .collection("goals")
    .where("type", "==", "daily")
    .get();

  if (snap.empty) {
    goalsBox.innerText = "No daily goals";
    return;
  }

  snap.forEach(doc => {
    const g = doc.data();
    if (g.completedDate === todayKey) return;

    const div = document.createElement("div");
    div.className = "goal";
    div.innerHTML = `
      <span>${g.title}</span>
      <button class="done">Done (+10 XP)</button>
    `;

    div.querySelector("button").onclick = () => completeGoal(user, doc.id);
    goalsBox.appendChild(div);
  });
}

async function completeGoal(user, goalId) {
  const userRef = db.collection("users").doc(user.email);

  await db.runTransaction(async tx => {
    const snap = await tx.get(userRef);
    const xp = snap.data().xp || 0;

    tx.update(userRef, { xp: xp + 10 });

    tx.update(userRef.collection("goals").doc(goalId), {
      completedDate: todayKey
    });

    tx.set(userRef.collection("xp_history").doc(), {
      change: +10,
      reason: "Completed daily goal",
      date: firebase.firestore.FieldValue.serverTimestamp()
    });
  });

  location.reload();
}

async function processMissedGoals(user) {
  const userRef = db.collection("users").doc(user.email);
  const goalsSnap = await userRef.collection("goals")
    .where("type", "==", "daily")
    .get();

  let penalty = 0;

  goalsSnap.forEach(doc => {
    const g = doc.data();
    if (g.completedDate !== todayKey && g.lastChecked !== todayKey) {
      penalty += 5;
      doc.ref.update({ lastChecked: todayKey });
    }
  });

  if (penalty > 0) {
    await userRef.update({
      xp: firebase.firestore.FieldValue.increment(-penalty)
    });

    await userRef.collection("xp_history").add({
      change: -penalty,
      reason: "Missed daily goals",
      date: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}

function logout() {
  auth.signOut();
}
</script>

</body>
</html>
