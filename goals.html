<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Goals</title>

<style>
body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  min-height: 100vh;
  padding: 30px;
}
h2 {
  text-align: center;
  color: white;
}
.container {
  max-width: 900px;
  margin: auto;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 20px;
}
.goal-card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 15px 30px rgba(0,0,0,.15);
}
.goal-title {
  font-size: 18px;
  font-weight: bold;
}
.goal-type, .goal-days {
  font-size: 14px;
  color: #6b7280;
}
.xp {
  margin-top: 8px;
  background: #eef2ff;
  color: #4338ca;
  padding: 6px 10px;
  border-radius: 20px;
  width: fit-content;
}
button {
  margin-top: 15px;
  padding: 10px;
  border-radius: 12px;
  border: none;
  font-weight: bold;
  cursor: pointer;
}
.done-btn {
  background: #4f46e5;
  color: white;
}
.completed-btn {
  background: #22c55e;
  color: white;
}
.disabled-btn {
  background: #d1d5db;
  color: #6b7280;
  cursor: not-allowed;
}
</style>
</head>

<body>

<h2>üìã Today‚Äôs Goals</h2>
<div class="container" id="goals"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc,
  updateDoc, increment, addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMEmLkJ8_-A1iSD_IF2NccOJHdcRm_Lug",
  authDomain: "study-2f23d.firebaseapp.com",
  projectId: "study-2f23d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const goalsDiv = document.getElementById("goals");

const today = new Date().toISOString().split("T")[0];
const todayDay = new Date().toLocaleDateString("en-US", { weekday: "short" });

function shouldShow(goal) {
  if (goal.type === "daily") return true;
  return goal.days?.includes(todayDay);
}

auth.onAuthStateChanged(async user => {
  if (!user) return;
  const email = user.email;

  const snap = await getDocs(
    collection(db, "users", email, "goals")
  );

  goalsDiv.innerHTML = "";

  for (const docSnap of snap.docs) {
    const g = docSnap.data();
    const ref = doc(db, "users", email, "goals", docSnap.id);

    /* üîÅ RESET DAILY */
    if (g.type === "daily" && g.lastShownDate !== today) {
      await updateDoc(ref, {
        completed: false,
        lastShownDate: today
      });
      g.completed = false;
    }

    /* ‚ùå MISS PENALTY */
    if (
      g.lastShownDate &&
      g.lastShownDate < today &&
      !g.completed &&
      g.lastPenaltyDate !== today &&
      shouldShow({ ...g, days: [todayDay] })
    ) {
      await updateDoc(ref, { lastPenaltyDate: today });

      await updateDoc(
        doc(db, "users", email),
        { xp: increment(-5) }
      );

      await addDoc(
        collection(db, "users", email, "xpHistory"),
        {
          amount: -5,
          reason: `Missed goal: ${g.title}`,
          timestamp: serverTimestamp()
        }
      );
    }

    if (!shouldShow(g)) continue;

    goalsDiv.innerHTML += `
      <div class="goal-card">
        <div class="goal-title">${g.title}</div>
        <div class="goal-type">Type: ${g.type}</div>
        ${g.days?.length ? `<div class="goal-days">Days: ${g.days.join(", ")}</div>` : ""}
        <div class="xp">‚≠ê 10 XP</div>

        ${
          g.completed
            ? `<button class="completed-btn">Completed ‚úî</button>`
            : `<button class="done-btn" onclick="completeGoal('${docSnap.id}', '${g.title}')">Mark as Done</button>`
        }
      </div>
    `;
  }
});

window.completeGoal = async (goalId, title) => {
  const user = auth.currentUser;
  if (!user) return;
  const email = user.email;

  await updateDoc(
    doc(db, "users", email, "goals", goalId),
    {
      completed: true,
      lastCompletedDate: today
    }
  );

  await updateDoc(
    doc(db, "users", email),
    { xp: increment(10) }
  );

  await addDoc(
    collection(db, "users", email, "xpHistory"),
    {
      amount: 10,
      reason: `Completed goal: ${title}`,
      timestamp: serverTimestamp()
    }
  );

  location.reload();
};
</script>

</body>
</html>
